---

#see jenkins-slave for a better java install
- name: Install Java 1.7
  yum: name=java-1.7.0-openjdk state=present
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux') and tomcat_jdk_enable

- name: Install Java 1.7
  apt: pkg=openjdk-7-jdk state=present update_cache=yes
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and tomcat_jdk_enable

#- name: Install Tomcat
#  yum: name={{ item }} state=present
#  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
#  with_items:
#   - tomcat7
#   - tomcat7-docs
#   - tomcat7-examples
#   - tomcat7-admin

- name: Install Tomcat
  apt: pkg={{ item }} state=present update_cache=yes
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  with_items:
   - libtcnative-1
   - tomcat7
   - tomcat7-docs
   - tomcat7-examples
   - tomcat7-admin

#- name: Download Tomcat
#  get_url: url=https://archive.apache.org/dist/tomcat/tomcat-7/v7.0.55/bin/apache-tomcat-7.0.55.tar.gz dest=/opt/apache-tomcat-7.0.55.tar.gz

#- name: Extract archive
#  command: chdir=/usr/share /bin/tar xvf /opt/apache-tomcat-7.0.55.tar.gz -C /usr/share/ creates={{ tomcat_catalina_home_dir }}

#- name: Symlink install directory
#  file: src=/usr/share/apache-tomcat-7.0.55 path=/usr/share/tomcat state=link

#- name: Add group "tomcat"
#  group: name=tomcat

#- name: Add user "tomcat"
#  user: name=tomcat group=tomcat home=/usr/share/tomcat

#- name: Change ownership of Tomcat installation
#  file: path={{ tomcat_catalina_home_dir }}/ owner=tomcat group=tomcat state=directory recurse=yes

- name: Configure Tomcat server
  template: src=server.xml.j2 dest={{ tomcat_catalina_home_dir }}/conf/server.xml
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
  notify: restart tomcat

- name: Configure Tomcat server
  template: src=server.xml.j2 dest={{ tomcat_catalina_base_dir }}/conf/server.xml
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  notify: restart tomcat

- name: Configure Tomcat users
  template: src=tomcat-users.xml.j2 dest={{ tomcat_catalina_home_dir }}/conf/tomcat-users.xml
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
  notify: restart tomcat

- name: Configure Tomcat users
  template: src=tomcat-users.xml.j2 dest={{ tomcat_conf_dir }}/tomcat-users.xml
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  notify: restart tomcat

#- name: Install Tomcat init script
#  copy: src=tomcat-initscript.sh dest=/etc/init.d/tomcat mode=0755

- name: Configure tomcat startup file
  template: src=catalina.sh.j2 dest={{ tomcat_catalina_home_dir }}/bin/catalina.sh
  when: tomcat_startup_enabled
  tags: yourkit

- name: Tomcat can run any command with no password
  lineinfile: "line='tomcat ALL=NOPASSWD: ALL' dest=/etc/sudoers regexp='^tomcat' validate='visudo -cf %s'"

- name: Start Tomcat
  service: name=tomcat state=started enabled=yes
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux') and tomcat_started_check_enable

- name: Start Tomcat
  service: name=tomcat7 state=started enabled=yes
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and (ansible_distribution_version not in ['12.04']) and tomcat_started_check_enable
#  ignore_errors: yes

#- name: deploy iptables rules
#  template: src=iptables.j2 dest=/etc/sysconfig/iptables
#  notify: restart iptables

- name: wait for tomcat to start
  wait_for: port={{ tomcat_http_port }}
  when: (ansible_distribution_version not in ['12.04']) and tomcat_started_check_enable
#  ignore_errors: yes
