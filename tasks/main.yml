---

#see jenkins-slave for a better java install
- name: Install Java 1.7 (yum)
  yum: name=java-1.7.0-openjdk state=present
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux') and tomcat_jdk_enable and tomcat_version == "7"
  become : yes

- name: Install Java 1.7 (apt)
  apt: pkg={{ item }} state=present
  with_items:
   - openjdk-7-jdk
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and ansible_distribution_version not in ['16.04'] and tomcat_jdk_enable and tomcat_version == "7"
  become : yes

- name: Install Java 1.8 (apt)
  apt: pkg={{ item }} state=present
  with_items:
   - openjdk-8-jdk
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and ansible_distribution_version not in ['12.04', '14.04'] and tomcat_jdk_enable and tomcat_version != "7"
  become : yes

- name: Install Tomcat dependencies
  action: "{{ ansible_pkg_mgr}} name={{ item }} update_cache=yes state={{ util_pkg_state|default('present') }}"
  with_items:
   - libtcnative-1
  become : yes

- name: Install Tomcat
  action: "{{ ansible_pkg_mgr}} name={{ item }} update_cache=yes state={{ util_pkg_state|default('present') }}"
  with_items:
   - "{{tomcat_name}}"
   - "{{tomcat_name}}-docs"
   - "{{tomcat_name}}-examples"
   - "{{tomcat_name}}-admin"
  become : yes

#- name: Download Tomcat
#  get_url: url=https://archive.apache.org/dist/tomcat/tomcat-7/v7.0.55/bin/apache-tomcat-7.0.55.tar.gz dest=/opt/apache-tomcat-7.0.55.tar.gz

#- name: Extract archive
#  command: chdir=/usr/share /bin/tar xvf /opt/apache-tomcat-7.0.55.tar.gz -C /usr/share/ creates={{ tomcat_catalina_home_dir }}

#- name: Symlink install directory
#  file: src=/usr/share/apache-tomcat-7.0.55 path=/usr/share/tomcat state=link

#- name: Add group "tomcat"
#  group: name=tomcat

#- name: Add user "tomcat"
#  user: name=tomcat group=tomcat home=/usr/share/tomcat

#- name: Change ownership of Tomcat installation
#  file: path={{ tomcat_catalina_home_dir }}/ owner=tomcat group=tomcat state=directory recurse=yes

- name: Configure Tomcat server
  template: src=server.xml.j2 dest={{ tomcat_catalina_home_dir }}/conf/server.xml
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat server
  template: src=server.xml.j2 dest={{ tomcat_catalina_base_dir }}/conf/server.xml
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat users
  template: src=tomcat-users.xml.j2 dest={{ tomcat_catalina_home_dir }}/conf/tomcat-users.xml
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat users
  template: src=tomcat-users.xml.j2 dest={{ tomcat_conf_dir }}/tomcat-users.xml
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat web
  template: src=web.xml.j2 dest={{ tomcat_catalina_home_dir }}/conf/web.xml
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat web
  template: src=web.xml.j2 dest={{ tomcat_conf_dir }}/web.xml
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat context
  template: src=context.xml.j2 dest={{ tomcat_catalina_home_dir }}/conf/context.xml
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')
  become : yes  
  notify: restart tomcat

- name: Configure Tomcat context
  template: src=context.xml.j2 dest={{ tomcat_conf_dir }}/context.xml
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu')
  become : yes  
  notify: restart tomcat

#- name: Install Tomcat init script
#  copy: src=tomcat-initscript.sh dest=/etc/init.d/tomcat mode=0755

- name: Configure tomcat startup file
  template: src=catalina.sh.j2 dest={{ tomcat_catalina_home_dir }}/bin/catalina.sh
  when: tomcat_startup_enabled and tomcat_version == "7"
  become : yes  
  tags: tomcat

- name: Install boot service script
  template:
    src=tomcat.service.j2
    dest="/lib/systemd/system/{{ tomcat_name }}.service"
    owner=root
    group=root
     mode=0755
  #when: tomcat_startup_enabled and tomcat_version == "7"
  become : yes    
#  notify: restart tomcat

- name: Tomcat can run any command with no password
  lineinfile: "line='tomcat ALL=NOPASSWD: ALL' dest=/etc/sudoers regexp='^tomcat' validate='visudo -cf %s'"
  become : yes  

- name: Start Tomcat
  service: name=tomcat state=started enabled=yes
  when: (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux') and tomcat_started_check_enable
  become : yes    

- name: Start Tomcat
  service: name="{{tomcat_name}}" state=started enabled=yes
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and (ansible_distribution_version not in ['12.04']) and tomcat_started_check_enable
  become : yes    
#  ignore_errors: yes

#- name: deploy iptables rules
#  template: src=iptables.j2 dest=/etc/sysconfig/iptables
#  notify: restart iptables

- name: wait for tomcat to start
  wait_for: port={{ tomcat_http_port }}
  when: (ansible_distribution_version not in ['12.04']) and tomcat_started_check_enable
#  ignore_errors: yes
